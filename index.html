<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Школа Магии</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение скрипта Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Подключение Tone.js для звуков -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Подключение кастомных шрифтов -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'EB Garamond', serif;
            overscroll-behavior: none;
            background-color: #EAE0CF;
            color: #4E4234;
        }
        .font-magic { font-family: 'Cinzel Decorative', cursive; }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e9dccb; }
        ::-webkit-scrollbar-thumb { background: #B8860B; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0760a; }

        #loading-screen { background-color: #FDF2E0; }
        .aspect-16-9 { aspect-ratio: 16 / 9; }
        .fade-to-color { animation: fadeToColorAnim 3s ease-in forwards; }
        @keyframes fadeToColorAnim { from { opacity: 0; } to { opacity: 1; } }

        .survey-image-container::after {
            content: ''; position: absolute; inset: 0;
            box-shadow: inset 0 0 30px 10px #FDF2E0;
            pointer-events: none; border-radius: 0.5rem;
        }
        .survey-input {
            border: 2px solid #e9dccb; background-color: #fff; transition: all 0.3s;
        }
        .survey-input:focus {
            border-color: #B8860B; box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.2); outline: none;
        }
        /* Стили для нового лоадера */
        #app-loader-progress {
            background-color: #B8860B;
            transition: width 0.1s linear;
        }
        /* Стиль для масштабирования видео */
        .video-container {
            position: absolute; inset: 0; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .video-container video {
            min-width: 100%; min-height: 100%; width: auto; height: auto;
            transform: scale(1.15); /* Масштаб 115% для небольшого "отдаления" */
        }
    </style>
</head>
<body class="overflow-hidden">

    <!-- 1. ЭКРАН ЗАГРУЗКИ С ВИДЕО -->
    <div id="loading-screen" class="fixed inset-0 z-50">
        <div class="video-container">
            <video
                id="intro-video"
                src="intro.mp4"
                autoplay muted playsinline preload="metadata">
            </video>
        </div>
        <div id="video-fade-overlay" class="absolute inset-0 bg-[#FDF2E0] opacity-0 z-10"></div>
        <div id="unmute-button" class="absolute inset-0 bg-black/30 flex items-center justify-center cursor-pointer transition-opacity duration-300 z-20">
            <div class="text-center text-white p-4 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                <p class="mt-2 text-lg">Нажмите, чтобы включить звук</p>
            </div>
        </div>
    </div>

    <!-- 2. НОВЫЙ ЭКРАН ЗАГРУЗКИ ПРИЛОЖЕНИЯ -->
    <div id="app-loader-screen" class="hidden fixed inset-0 z-40 flex flex-col items-center justify-center bg-[#FDF2E0]">
        <div class="text-center">
            <svg class="mx-auto h-16 w-16 text-[#B8860B] animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="font-magic text-2xl mt-4 text-[#B8860B]">Открываем книгу...</p>
            <div class="w-64 max-w-full bg-white/50 rounded-full h-2.5 mt-4 mx-auto">
                <div id="app-loader-progress" class="h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <p id="app-loader-percent" class="mt-2 text-lg font-semibold text-gray-600">0%</p>
        </div>
    </div>


    <!-- 3. ОСНОВНОЙ КОНТЕЙНЕР ПРИЛОЖЕНИЯ (Книжный макет) -->
    <div class="max-w-2xl mx-auto h-screen bg-[#FDF2E0] shadow-2xl shadow-black/20 flex flex-col relative">
        <div id="main-content" class="hidden h-full flex flex-col">
            <!-- Сюда будут вставляться экраны: опрос, наборы, уроки, детали -->
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="policy-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-[#FDF2E0] rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <h2 class="font-magic text-2xl text-center p-4 border-b border-[#e9dccb]">Политика конфиденциальности</h2>
            <div id="policy-content" class="overflow-y-auto p-6 text-sm space-y-3">
                <!-- Содержимое политики будет вставлено здесь из JS -->
            </div>
            <div class="p-4 border-t border-[#e9dccb] text-center">
                <button data-action="agree-policy-modal" class="bg-[#B8860B] text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-[#a0760a] transition-colors">Согласен</button>
            </div>
        </div>
    </div>
    <div id="disagree-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-[#FDF2E0] rounded-lg shadow-2xl max-w-sm w-full p-6 text-center">
            <h2 class="font-magic text-2xl mb-4">Очень жаль!</h2>
            <p class="mb-6">К сожалению, без согласия на обработку данных мы не можем предоставить вам доступ к Школе Магии.</p>
            <div class="flex flex-col gap-4">
                <button data-action="agree-disagree-modal" class="bg-[#B8860B] text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-[#a0760a] transition-colors">Я согласен с политикой</button>
                <button data-action="close-app" class="bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-lg text-lg hover:bg-gray-400 transition-colors">Закрыть приложение</button>
            </div>
        </div>
    </div>


<script>
    const magicSets=[{id:'set1',name:'Набор "75 лучших фокусов"',image:'images/set1.jpg',lessons:[{id:'s1l1',name:'Фокус с волшебной палочкой и горшочком',image:'images/02.webp'},{id:'s1l2',name:'Фокус с волшебной палочкой и сердечком №1',image:'images/03.webp'},{id:'s1l3',name:'Фокус с волшебной палочкой №1',image:'images/04.webp'},{id:'s1l4',name:'Фокус с волшебной палочкой и сердечком №2',image:'images/05.webp'},{id:'s1l5',name:'Фокус с волшебной палочкой №2',image:'images/06.webp'},{id:'s1l6',name:'Фокус с волшебной палочкой №3',image:'images/07.webp'},{id:'s1l7',name:'Фокус с сердечками №1',image:'images/08.webp'},{id:'s1l8',name:'Фокус с башенкой с шариком',image:'images/09.webp'},{id:'s1l9',name:'Фокус с разделителем верёвки',image:'images/10.webp'},{id:'s1l10',name:'Фокус с верёвкой №1',image:'images/11.webp'},{id:'s1l11',name:'Фокус с разноцветными платками',image:'images/12.webp'},{id:'s1l12',name:'Фокус с платком и напальчником',image:'images/13.webp'},{id:'s1l13',name:'Фокус с сердечками №2',image:'images/14.webp'},{id:'s1l14',name:'Фокус с сердечками №3',image:'images/15.webp'},{id:'s1l15',name:'Фокус с сердечками №4',image:'images/16.webp'},{id:'s1l16',name:'Фокус с сердечками №5',image:'images/17.webp'},{id:'s1l17',name:'Фокус с числовыми картами',image:'images/18.webp'},{id:'s1l18',name:'Фокус с баночкой с кубиками',image:'images/19.webp'},{id:'s1l19',name:'Фокус с игральным кубиком',image:'images/20.webp'},{id:'s1l20',name:'Фокус с двойными картами',image:'images/21.webp'},{id:'s1l21',name:'Фокус с картой со створкой',image:'images/22.webp'},{id:'s1l22',name:'Фокус со сложенной купюрой',image:'images/23.webp'},{id:'s1l23',name:'Фокус с картой и купюрой',image:'images/24.webp'},{id:'s1l24',name:'Фокус с купюрой',image:'images/25.webp'},{id:'s1l25',name:'Фокус с купюрой со скрепками',image:'images/26.webp'},{id:'s1l26',name:'Фокус со скрепками',image:'images/27.webp'},{id:'s1l27',name:'Фокус со стаканами и шариками',image:'images/28.webp'},{id:'s1l28',name:'Фокус с кольцом и цепочкой',image:'images/29.webp'},{id:'s1l29',name:'Фокус с монеткой №1',image:'images/30.webp'},{id:'s1l30',name:'Фокус с резинкой и скрепкой №1',image:'images/31.webp'},{id:'s1l31',name:'Фокус с резинкой и скрепкой №2',image:'images/32.webp'},{id:'s1l32',name:'Фокус с резинками №1',image:'images/33.webp'},{id:'s1l33',name:'Фокус с резинками №2',image:'images/34.webp'},{id:'s1l34',name:'Фокус с резинками и купюрой',image:'images/35.webp'},{id:'s1l35',name:'Фокус с резинкой и купюрой',image:'images/36.webp'},{id:'s1l36',name:'Фокус с резинкой',image:'images/37.webp'},{id:'s1l37',name:'Фокус с резинками №3',image:'images/38.webp'},{id:'s1l38',name:'Фокус с резинками №4',image:'images/39.webp'},{id:'s1l39',name:'Фокус с резинками №5',image:'images/40.webp'},{id:'s1l40',name:'Фокус с картой с леской и спичкой',image:'images/41.webp'},{id:'s1l41',name:'Фокус с верёвкой и спичечным коробком',image:'images/42.webp'},{id:'s1l42',name:'Фокус со спичечным коробком №1',image:'images/43.webp'},{id:'s1l43',name:'Три загадки со спичками',image:'images/44.webp'},{id:'s1l44',name:'Фокус со спичкой №1',image:'images/45.webp'},{id:'s1l45',name:'Фокус со спичкой №2',image:'images/46.webp'},{id:'s1l46',name:'Фокус со спичечным коробком №2',image:'images/47.webp'},{id:'s1l47',name:'Фокус со спичечным коробком и воздушным шариком',image:'images/48.webp'},{id:'s1l48',name:'Фокус с воздушным шариком',image:'images/49.webp'},{id:'s1l49',name:'Фокус с монеткой и стаканом №1',image:'images/50.webp'},{id:'s1l50',name:'Фокус с монеткой №2',image:'images/51.webp'},{id:'s1l51',name:'Фокус с монеткой и стаканом №2',image:'images/52.webp'},{id:'s1l52',name:'Фокус с карандашом №1',image:'images/53.webp'},{id:'s1l53',name:'Фокус с волшебной палочкой №4',image:'images/54.webp'},{id:'s1l54',name:'Фокус с разноцветными предметами',image:'images/55.webp'},{id:'s1l55',name:'Фокус со стаканами и предсказанием №1',image:'images/56.webp'},{id:'s1l56',name:'Фокус со стаканами и предсказанием №2',image:'images/57.webp'},{id:'s1l57',name:'Фокус с использованием рук №1',image:'images/58.webp'},{id:'s1l58',name:'Фокус с использованием рук №2',image:'images/59.webp'},{id:'s1l59',name:'Фокус со стаканом с жидкостью',image:'images/60.webp'},{id:'s1l60',name:'Фокус с напальчником',image:'images/61.webp'},{id:'s1l61',name:'Фокус с использованием пальцев №1',image:'images/62.webp'},{id:'s1l62',name:'Фокус с использованием пальцев №2',image:'images/63.webp'},{id:'s1l63',name:'Фокус с использованием пальцев №3',image:'images/64.webp'},{id:'s1l64',name:'Фокус с использованием пальцев №4',image:'images/65.webp'},{id:'s1l65',name:'Фокус с использованием пальцев №5',image:'images/66.webp'},{id:'s1l66',name:'Фокус с листом бумаги',image:'images/67.webp'},{id:'s1l67',name:'Три способа достать купюру из-под бутылки',image:'images/68.webp'},{id:'s1l68',name:'Фокус с верёвкой №2',image:'images/69.webp'},{id:'s1l69',name:'Фокус с карандашом №2',image:'images/70.webp'},{id:'s1l70',name:'Фокус с использованием пальцев №6',image:'images/71.webp'},{id:'s1l71',name:'Фокус с монеткой №3',image:'images/72.webp'},{id:'s1l72',name:'Фокус с иллюзией левитации',image:'images/73.webp'},{id:'s1l73',name:'Фокус с вопросами',image:'images/74.webp'},{id:'s1l74',name:'Фокус с числами',image:'images/75.webp'},{id:'s1l75',name:'Фокус с кольцом',image:'images/76.webp'}]},{id:'set2',name:'Набор "10 взрывных фокусов" (жёлтый)',image:'images/set2.jpg',lessons:[{id:'s2l1',name:'Фокус с разделителем верёвки',image:'images/set2/201.webp'},{id:'s2l2',name:'Фокус с разноцветными платками',image:'images/set2/202.webp'},{id:'s2l3',name:'Фокус с баночкой с кубиками',image:'images/set2/203.webp'},{id:'s2l4',name:'Фокус с купюрой со скрепками',image:'images/set2/204.webp'},{id:'s2l5',name:'Фокус с карточкой клоуна',image:'images/set2/205.webp'},{id:'s2l6',name:'Фокус с резинкой №1',image:'images/set2/206.webp'},{id:'s2l7',name:'Фокус с резинками №1',image:'images/set2/207.webp'},{id:'s2l8',name:'Фокус с калькулятором',image:'images/set2/208.webp'},{id:'s2l9',name:'Фокус с резинкой №2',image:'images/set2/209.webp'},{id:'s2l10',name:'Фокус с резинками №2',image:'images/set2/210.webp'}]},{id:'set3',name:'Набор "10 взрывных фокусов" (зелёный)',image:'images/set3.jpg',lessons:[{id:'s3l1',name:'Фокус со стаканами и шариками',image:'images/set3/301.webp'},{id:'s3l2',name:'Фокус с картой с леской и спичкой',image:'images/set3/302.webp'},{id:'s3l3',name:'Фокус с печеньем',image:'images/set3/303.webp'},{id:'s3l4',name:'Фокус с волшебной тростью',image:'images/set3/304.webp'},{id:'s3l5',name:'Фокус с карточкой сердечка',image:'images/set3/305.webp'},{id:'s3l6',name:'Фокус с резинкой №1',image:'images/set3/306.webp'},{id:'s3l7',name:'Фокус с резинками №1',image:'images/set3/307.webp'},{id:'s3l8',name:'Фокус с резинками №2',image:'images/set3/308.webp'},{id:'s3l9',name:'Фокус с резинкой №2',image:'images/set3/309.webp'},{id:'s3l10',name:'Фокус с использованием рук',image:'images/set3/310.webp'},{id:'s3l11',name:'Фокус с калькулятором',image:'images/set3/311.webp'}]},{id:'set4',name:'Набор "10 взрывных фокусов" (синий)',image:'images/set4.jpg',lessons:[{id:'s4l1',name:'Фокус с башенкой с шариком',image:'images/set4/401.webp'},{id:'s4l2',name:'Фокус с платком и напальчником',image:'images/set4/402.webp'},{id:'s4l3',name:'Фокус с двойными картами',image:'images/set4/403.webp'},{id:'s4l4',name:'Фокус с карточкой “Дай пять”',image:'images/set4/404.webp'},{id:'s4l5',name:'Фокус с колодой в футляре',image:'images/set4/405.webp'},{id:'s4l6',name:'Фокус с купюрой и бумажкой №1',image:'images/set4/406.webp'},{id:'s4l7',name:'Фокус с купюрой и бумажкой №2',image:'images/set4/407.webp'},{id:'s4l8',name:'Фокус с резинкой №1',image:'images/set4/408.webp'},{id:'s4l9',name:'Фокус с использованием рук',image:'images/set4/409.webp'},{id:'s4l10',name:'Фокус с резинкой №2',image:'images/set4/410.webp'},{id:'s4l11',name:'Фокус с резинкой №3',image:'images/set4/411.webp'}]},{id:'set5',name:'Набор "10 взрывных фокусов" (красный)',image:'images/set5.jpg',lessons:[{id:'s5l1',name:'Фокус с числовыми картами',image:'images/set5/501.webp'},{id:'s5l2',name:'Фокус с кольцом и цепочкой',image:'images/set5/502.webp'},{id:'s5l3',name:'Фокус с кошельком с картами',image:'images/set5/503.webp'},{id:'s5l4',name:'Фокус с баночкой с кубиком',image:'images/set5/504.webp'},{id:'s5l5',name:'Фокус с поролоновыми шариками и кубиком №1',image:'images/set5/505.webp'},{id:'s5l6',name:'Фокус с поролоновыми шариками №1',image:'images/set5/506.webp'},{id:'s5l7',name:'Фокус с поролоновыми шариками №2',image:'images/set5/507.webp'},{id:'s5l8',name:'Фокус с поролоновыми шариками №3',image:'images/set5/508.webp'},{id:'s5l9',name:'Фокус с поролоновыми шариками и кубиком №2',image:'images/set5/509.webp'},{id:'s5l10',name:'Фокус с выбором предмета',image:'images/set5/510.webp'},{id:'s5l11',name:'Фокус с резинками',image:'images/set5/511.webp'},{id:'s5l12',name:'Фокус с резинками и прищепкой',image:'images/set5/512.webp'},{id:'s5l13',name:'Фокус с кольцом и монеткой',image:'images/set5/513.webp'},{id:'s5l14',name:'Фокус с резинками',image:'images/set5/514.webp'}]}];
    const policyText=`<p class="font-bold">Дата публикации действующей редакции: 1 сентября 2025 года</p><h3 class="font-bold text-base pt-2">1. Общие положения, стороны, цель документа</h3><p>1.1. Настоящая Политика конфиденциальности и обработки персональных данных (далее – «Политика») определяет порядок и условия обработки индивидуальным предпринимателем Таранюком Русланом Жановичем, действующим по законодательству Российской Федерации (далее – «Оператор» либо «Мы»), информации о физическом лице, которая может быть получена Оператором от этого физического лица либо его законного представителя (далее – «Пользователь», «Субъект персональных данных» либо «Вы»).</p><p>1.2. Политика регулирует отношения, возникающие при использовании Пользователем Telegram-ботов, закрытых чатов, веб-страниц и иных сервисов проекта «Секретный клуб волшебников».</p><p>1.3. Цель Политики — обеспечение надлежащего правового режима персональных данных, защита прав и свобод Пользователей, а также выполнение требований Федерального закона № 152-ФЗ «О персональных данных».</p><h3 class="font-bold text-base pt-2">2. Правовые основания обработки</h3><p>2.1. Обработка персональных данных осуществляется на основании: согласия Пользователя (ст. 6 ФЗ-152); договорных отношений (оферта, соглашение, акцепт условий участия в проекте); иных правовых оснований, предусмотренных законодательством РФ.</p><p>2.2. Согласие Пользователь выражает свободно и явно, например: нажатием кнопки «Продолжить» в Telegram-боте; установкой галочки «Согласен с Политикой конфиденциальности»; участием в опросах, челленджах, активностях в рамках проекта.</p><h3 class="font-bold text-base pt-2">3. Правила обработки персональных данных</h3><p>3.1. Цели обработки: предоставление доступа к сервисам проекта; идентификация и обратная связь с Пользователями; проведение мероприятий, челленджей, опросов; анализ предпочтений и интересов Пользователей для улучшения сервиса; маркетинговые и статистические исследования; информирование о новостях, обновлениях, акциях; выполнение договорных обязательств.</p><p>3.2. Категории данных: Оператор может обрабатывать следующие персональные данные: имя, возраст, пол; Telegram ID и никнейм; контактные данные (телефон, e-mail — если предоставлены); ответы Пользователя на вопросы и опросы; информация об интересах и предпочтениях (например, количество освоенных фокусов, участие в челленджах); изображения, видеозаписи, голос (если Пользователь сам отправил медиа или участвовал в трансляции/опросе). (Таким образом, любые будущие данные, которые Пользователь предоставит добровольно в рамках сервиса, также подпадают под действие этой Политики.)</p><p>3.3. Способы обработки: Сбор, запись, систематизация, хранение, уточнение, использование, обезличивание, передача, блокирование, удаление, уничтожение.</p><p>3.4. Сроки хранения: Персональные данные хранятся до: отзыва согласия Пользователем; либо 5 (пяти) лет с момента последнего взаимодействия.</p><p>3.5. Уничтожение данных: При достижении целей или отзыве согласия данные уничтожаются с составлением акта.</p><p>3.6. Cookies: При использовании веб-страниц проекта (например, Taplink, сайт) могут применяться файлы cookie. Пользователь может отключить их самостоятельно в настройках браузера.</p><h3 class="font-bold text-base pt-2">4. Права и обязанности</h3><p>4.1. Пользователь имеет право: получать информацию об обработке его персональных данных; требовать исправления или удаления данных; отзывать согласие на обработку; направлять запросы и жалобы на e-mail Оператора.</p><p>4.2. Оператор обязуется: обрабатывать данные строго в соответствии с заявленными целями; принимать технические и организационные меры защиты; не передавать данные третьим лицам без законных оснований или согласия Пользователя.</p><h3 class="font-bold text-base pt-2">5. Хранение и передача данных</h3><p>5.1. Персональные данные граждан РФ хранятся в базах данных, расположенных на территории Российской Федерации.</p><p>5.2. При использовании сервисов третьих лиц (например, Google Sheets, Cloud-сервисов) возможна трансграничная передача данных. Оператор принимает меры по защите прав Пользователей и уведомляет уполномоченный орган, если это требуется по закону.</p><p>5.3. Передача данных допускается: по требованию суда и госорганов; для защиты прав и интересов Оператора и Пользователей; при согласии Пользователя.</p><h3 class="font-bold text-base pt-2">6. Изменение Политики</h3><p>6.1. Оператор имеет право изменять Политику. Новая редакция размещается с указанием даты обновления.</p><p>6.2. Действующая редакция Политики всегда доступна по ссылке в Telegram-боте.</p><h3 class="font-bold text-base pt-2">7. Реквизиты Оператора</h3><p>Индивидуальный предприниматель Таранюк Руслан Жанович<br>ИНН: 540863428069<br>ОГРНИП: 316547600142877<br>Адрес: 640001, Курганская область, городской округ город Курган, город Курган, улица Коли Мяготина, дом 91, кв. 17<br>Тел.: +7 (953) 884-96-73<br>E-mail: taruslan@mail.ru</p>`;

    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); 
        
        const user = tg.initDataUnsafe?.user || { id: 123456, username: 'testuser' };
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSBegPmiE4OGY8ZalZpu301oiojA-D9O9tO-SDT8KH9ImGa1alejmevzVZXIDkD5ew0w/exec';

        // Элементы UI
        const loadingScreen = document.getElementById('loading-screen');
        const introVideo = document.getElementById('intro-video');
        const unmuteButton = document.getElementById('unmute-button');
        const videoFadeOverlay = document.getElementById('video-fade-overlay');
        const appLoaderScreen = document.getElementById('app-loader-screen');
        const mainContent = document.getElementById('main-content');
        const policyModal = document.getElementById('policy-modal');
        const disagreeModal = document.getElementById('disagree-modal');
        
        let currentSetId = null;
        const surveyData = {};

        // --- ИНИЦИАЛИЗАЦИЯ ЗВУКОВ ---
        let synth;
        try {
            synth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
            }).toDestination();
        } catch (e) {
            console.warn("Tone.js не смог инициализироваться. Звуков не будет.", e);
        }
        
        function playSound() {
            if (synth && Tone.context.state === 'running') {
                synth.triggerAttackRelease("C5", "8n");
            }
        }
        
        document.body.addEventListener('click', () => {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
        }, { once: true });


        // --- ЛОГИКА ЗАГРУЗКИ ---
        function transitionToApp() {
            if (!loadingScreen) return;
            
            loadingScreen.classList.add('fade-out');
            loadingScreen.addEventListener('animationend', () => {
                if (loadingScreen) loadingScreen.remove();
                appLoaderScreen.classList.remove('hidden');
                appLoaderScreen.classList.add('fade-in');
                simulateLoadingAndCheckSurvey();
            }, { once: true });
        }
        
        function simulateLoadingAndCheckSurvey() {
            const loaderProgress = document.getElementById('app-loader-progress');
            const loaderPercent = document.getElementById('app-loader-percent');
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.floor(Math.random() * 5) + 1;
                if (progress > 100) progress = 100;
                loaderProgress.style.width = progress + '%';
                loaderPercent.textContent = progress + '%';
                if (progress === 100) {
                    clearInterval(interval);
                }
            }, 50);

            checkSurveyCompletion().finally(() => {
                clearInterval(interval);
                loaderProgress.style.width = '100%';
                loaderPercent.textContent = '100%';
                
                setTimeout(() => {
                    appLoaderScreen.classList.add('fade-out');
                    appLoaderScreen.addEventListener('animationend', () => {
                        if (appLoaderScreen) appLoaderScreen.remove();
                        mainContent.classList.remove('hidden');
                        mainContent.classList.add('fade-in');
                        document.body.classList.remove('overflow-hidden');
                    }, { once: true });
                }, 300);
            });
        }

        unmuteButton.addEventListener('click', () => {
            playSound();
            introVideo.muted = false;
            unmuteButton.classList.add('fade-out');
            unmuteButton.addEventListener('animationend', () => unmuteButton.style.display = 'none', { once: true });
            introVideo.play();
        }, { once: true });
        
        introVideo.addEventListener('loadedmetadata', () => {
            const videoDuration = introVideo.duration;
            const fadeStart = videoDuration - 3; 
            if (fadeStart > 0) setTimeout(() => videoFadeOverlay.classList.add('fade-to-color'), fadeStart * 1000);
        });
        introVideo.addEventListener('ended', transitionToApp);
        setTimeout(transitionToApp, 8000); // Failsafe


        // --- ЛОГИКА ОПРОСА И GOOGLE SHEETS ---
        async function checkSurveyCompletion() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=check&userId=${user.id}`);
                const result = await response.json();
                if (result.completed) {
                    showView('sets');
                } else {
                    showView('survey', 1);
                }
            } catch (error) {
                console.error('Ошибка при проверке опроса:', error);
                showView('survey', 1);
            }
        }

        async function submitSurvey() {
            const formData = new FormData();
            formData.append('telegramId', user.id);
            formData.append('username', user.username || 'не указан');
            formData.append('name', surveyData.name);
            formData.append('age', surveyData.age);
            formData.append('tricks', surveyData.tricks);
            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
            } catch (error) {
                console.error('Ошибка при отправке опроса:', error);
            }
            showView('sets');
        }

        // --- ГЕНЕРАЦИЯ HTML ДЛЯ ЭКРАНОВ ---
        function getSetsViewHTML() {
            let setsHTML = '';
            magicSets.forEach(set => {
                setsHTML += `
                    <div class="bg-white/60 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-all duration-300 hover:border-[#B8860B] border border-transparent overflow-hidden flex flex-col" data-action="show-lessons" data-set-id="${set.id}">
                        <img src="${set.image}" alt="${set.name}" class="w-full h-auto object-cover" loading="lazy" onerror="this.style.display='none'">
                        <h3 class="font-magic text-xl text-center text-[#B8860B] p-4">${set.name}</h3>
                    </div>`;
            });
            return `
                <div class="p-4 sm:p-6 flex-grow flex flex-col">
                    <header class="text-center mb-6">
                        <h1 class="font-magic text-3xl sm:text-4xl text-[#B8860B] tracking-wider">Школа Магии</h1>
                        <p class="text-gray-600 mt-2 text-lg">Выберите Ваш набор фокусов</p>
                    </header>
                    <main class="flex-grow flex flex-col gap-6 overflow-y-auto pr-2">${setsHTML}</main>
                </div>`;
        }

        function getLessonsViewHTML(setId) {
            const set = magicSets.find(s => s.id === setId);
            if (!set) return '';
            currentSetId = setId;

            let lessonsHTML = '';
            set.lessons.forEach(lesson => {
                lessonsHTML += `
                    <div class="py-3 border-b border-[#e9dccb] cursor-pointer transition-all duration-300 flex items-center space-x-4 hover:bg-white/70 rounded-md p-2" data-action="show-lesson-detail" data-lesson-id="${lesson.id}">
                        <div class="w-24 flex-shrink-0">
                            <div class="aspect-16-9 w-full bg-[#e9dccb] rounded-md overflow-hidden">
                                <img src="${lesson.image}" alt="${lesson.name}" class="w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'">
                            </div>
                        </div>
                        <span class="flex-1 font-medium text-lg">${lesson.name}</span>
                    </div>`;
            });

            return `
                <div class="flex-grow flex flex-col h-full">
                    <header class="sticky top-0 bg-[#FDF2E0] bg-opacity-90 backdrop-blur-sm z-10 p-4">
                        <button data-action="show-sets" class="flex items-center text-[#B8860B] hover:text-[#a0760a] transition-colors mb-4 p-2 -ml-2 rounded-full hover:bg-white/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            <span class="text-lg">Назад</span>
                        </button>
                        <h2 class="font-magic text-2xl sm:text-3xl text-[#B8860B] text-center">${set.name}</h2>
                    </header>
                    <main class="flex-grow overflow-y-auto px-4 space-y-1">${lessonsHTML}</main>
                </div>`;
        }

        function getLessonDetailViewHTML(lessonId) {
            const set = magicSets.find(s => s.id === currentSetId);
            const lesson = set?.lessons.find(l => l.id === lessonId);
            if (!lesson) return '';

            return `
                <div class="flex-grow flex flex-col h-full p-4 sm:p-6">
                    <header class="mb-4 flex-shrink-0">
                        <button data-action="show-lessons" data-set-id="${currentSetId}" class="flex items-center text-[#B8860B] hover:text-[#a0760a] transition-colors p-2 -ml-2 rounded-full hover:bg-white/50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            <span class="text-lg">К урокам</span>
                        </button>
                    </header>
                    <main class="flex-grow flex flex-col items-center gap-6 overflow-y-auto pb-4">
                        <div class="w-full rounded-lg overflow-hidden shadow-lg relative survey-image-container">
                            <img src="${lesson.image}" alt="${lesson.name}" class="w-full h-auto object-cover rounded-lg">
                        </div>
                        <h2 class="font-magic text-2xl sm:text-3xl text-center text-[#4E4234] flex-shrink-0">${lesson.name}</h2>
                        <div class="w-full mt-auto pt-4 flex-shrink-0">
                             <button data-action="watch-lesson" data-image-path="${lesson.image}" class="w-full max-w-sm mx-auto bg-[#B8860B] text-white font-bold py-4 px-6 rounded-lg text-xl hover:bg-[#a0760a] transition-transform duration-200 hover:scale-105 shadow-lg flex items-center justify-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 001.553.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                                <span>Посмотреть урок</span>
                            </button>
                        </div>
                    </main>
                </div>`;
        }

        function getSurveyStepHTML(step){switch(step){case 1:return`<div class="flex-grow flex flex-col items-center justify-center text-center gap-6"><div class="w-full max-w-xs relative survey-image-container"><img src="images/survey/1.jpg" class="w-full h-auto rounded-lg"></div><h2 class="text-xl font-semibold">Вам есть 14 лет?</h2><p class="text-gray-600 -mt-4">Если нет — нужно согласие родителей.</p><div class="w-full flex flex-col gap-4 max-w-sm"><button data-action="next-step" data-step="2" class="w-full bg-white/80 p-4 rounded-lg text-lg font-semibold hover:bg-white transition-colors">Да, мне 14+</button><button data-action="next-step" data-step="2" class="w-full bg-white/80 p-4 rounded-lg text-lg font-semibold hover:bg-white transition-colors">До 14, согласие есть</button></div></div>`;case 2:return`<div class="flex-grow flex flex-col items-center justify-center text-center gap-6"><div class="w-full max-w-xs relative survey-image-container"><img src="images/survey/2.jpg" class="w-full h-auto rounded-lg"></div><h2 class="text-xl font-semibold">Политика и обработка персональных данных</h2><p class="text-gray-600 -mt-4 max-w-md">Нажимая "Продолжить", вы соглашаетесь с обработкой персональных данных в соотвествии с Политикой конфиденциальности.</p><div class="w-full flex flex-col gap-4 max-w-sm"><button data-action="next-step" data-step="3" class="w-full bg-[#B8860B] text-white p-4 rounded-lg text-lg font-semibold hover:bg-[#a0760a] transition-colors">Продолжить</button><button data-action="show-policy" class="w-full bg-white/80 p-4 rounded-lg text-lg font-semibold hover:bg-white transition-colors">Ознакомиться</button><button data-action="disagree" class="w-full text-gray-500 p-2 rounded-lg text-base hover:text-gray-800 transition-colors">Не согласен</button></div></div>`;case 3:return`<div class="flex-grow flex flex-col items-center justify-center text-center gap-6"><div class="w-full max-w-xs relative survey-image-container"><img src="images/survey/3.jpg" class="w-full h-auto rounded-lg"></div><h2 class="text-xl font-semibold">Как можно к тебе обращаться?</h2><p class="text-gray-600 -mt-4 max-w-md">Чтобы получить доступ к бесплатным видеоурокам, ответьте на три вопроса.</p><div class="w-full flex flex-col gap-4 max-w-sm"><input id="survey-name" type="text" placeholder="Ваше имя" class="w-full p-4 rounded-lg text-lg text-center survey-input"><button data-action="save-text" data-step="4" data-input-id="survey-name" data-key="name" class="w-full bg-[#B8860B] text-white p-4 rounded-lg text-lg font-semibold hover:bg-[#a0760a] transition-colors">Далее</button></div></div>`;case 4:return`<div class="flex-grow flex flex-col items-center justify-center text-center gap-6"><div class="w-full max-w-xs relative survey-image-container"><img src="images/survey/4.jpg" class="w-full h-auto rounded-lg"></div><h2 class="text-xl font-semibold">Сколько тебе лет?</h2><div class="w-full flex flex-col gap-4 max-w-sm"><input id="survey-age" type="number" placeholder="Ваш возраст" class="w-full p-4 rounded-lg text-lg text-center survey-input"><button data-action="save-text" data-step="5" data-input-id="survey-age" data-key="age" class="w-full bg-[#B8860B] text-white p-4 rounded-lg text-lg font-semibold hover:bg-[#a0760a] transition-colors">Далее</button></div></div>`;case 5:return`<div class="flex-grow flex flex-col items-center justify-center text-center gap-6"><div class="w-full max-w-xs relative survey-image-container"><img src="images/survey/5.jpg" class="w-full h-auto rounded-lg"></div><h2 class="text-xl font-semibold">Сколько фокусов ты уже знаешь?</h2><div class="w-full flex flex-col gap-4 max-w-sm"><input id="survey-tricks" type="number" placeholder="Количество" class="w-full p-4 rounded-lg text-lg text-center survey-input"><button data-action="save-text-final" data-input-id="survey-tricks" data-key="tricks" class="w-full bg-[#B8860B] text-white p-4 rounded-lg text-lg font-semibold hover:bg-[#a0760a] transition-colors">Завершить</button></div></div>`;}return'';}

        // --- УПРАВЛЕНИЕ ВИДАМИ (ЭКРАНАМИ) ---
        function showView(viewName, param) {
            playSound();
            let html = '';
            switch(viewName) {
                case 'sets':
                    html = getSetsViewHTML();
                    break;
                case 'lessons':
                    html = getLessonsViewHTML(param);
                    break;
                case 'lesson-detail':
                    html = getLessonDetailViewHTML(param);
                    break;
                case 'survey':
                    html = `<div class="p-4 sm:p-6 flex-grow flex flex-col h-full">${getSurveyStepHTML(param)}</div>`;
                    break;
            }
            mainContent.innerHTML = html;
            mainContent.scrollTop = 0; // Сбрасываем скролл при смене экрана
        }

        // --- ЕДИНЫЙ ОБРАБОТЧИК КЛИКОВ ---
        document.body.addEventListener('click', (e) => {
            const button = e.target.closest('div[data-action], button[data-action]');
            if (!button) return;

            playSound();
            const { action, step, inputId, key, setId, lessonId, imagePath } = button.dataset;

            switch(action) {
                case 'next-step':
                    showView('survey', parseInt(step));
                    break;
                case 'show-policy':
                    document.getElementById('policy-content').innerHTML = policyText;
                    policyModal.classList.remove('hidden');
                    break;
                case 'disagree':
                    disagreeModal.classList.remove('hidden');
                    break;
                case 'agree-policy-modal':
                    policyModal.classList.add('hidden');
                    showView('survey', 3);
                    break;
                case 'agree-disagree-modal':
                    disagreeModal.classList.add('hidden');
                    showView('survey', 3);
                    break;
                case 'close-app':
                    tg.close();
                    break;
                case 'save-text':
                case 'save-text-final': {
                    const inputEl = document.getElementById(inputId);
                    if (inputEl.value.trim() === '') {
                        inputEl.classList.add('border-red-500');
                        return;
                    }
                    surveyData[key] = inputEl.value;
                    if (action === 'save-text-final') {
                        submitSurvey();
                    } else {
                        showView('survey', parseInt(step));
                    }
                    break;
                }
                case 'show-sets':
                    showView('sets');
                    break;
                case 'show-lessons':
                    showView('lessons', setId);
                    break;
                case 'show-lesson-detail':
                    showView('lesson-detail', lessonId);
                    break;
                case 'watch-lesson':
                    const filename = imagePath.split('/').pop();
                    const dataToSend = filename.split('.')[0];
                    if (tg.sendData) {
                        tg.sendData(dataToSend);
                        tg.close();
                    } else {
                        console.log('Тестовый режим. Отправка данных:', dataToSend);
                    }
                    break;
            }
        });
    });
</script>

</body>
</html>

